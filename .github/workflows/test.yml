name: Testing

on: [push, pull_request]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        python-version: [2.7, 3.6, 3.7, 3.8]

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Ubuntu dependencies
      run: |
        ./bootstrap.sh /tmp/target-python/bin/python
        echo "{KMD_PYTHON}={$PWD/boot/kmd-env/bin/python}" >> $GITHUB_ENV

    - name: Unit tests
      run: $KMD_PYTHON -m pytest tests

    - name: Lint tests
      run: |
        $KMD_PYTHON -m komodo.lint examples/releases/unstable.yml examples/repository.yml
        $KMD_PYTHON -m komodo.lint examples/releases/ecl.yml examples/repository.yml

    - name: Full integration test
      run: |
        ./runkmd.sh ci/travis/${RELEASE} ci/travis/repository.yml --workspace /tmp/kmd-ws --cache /tmp/kmd-cache --prefix /tmp/pfx --release travis --locations-config $(realpath ci/travis/locations.yml) --renamer rename.ul
    - name: Build libkmd.so for testing
      run: |
        ci/travis/build_lib.sh /tmp/pfx/travis

        source /tmp/pfx/travis/enable
        which python
        python --version
        python -c "import numpy;print(numpy.__file__)"
        ci/travis/test_import_lib.py

    - name: Test that everything makes sense
      run: |
        '[[ "$(which python)" == "/tmp/pfx/travis/root/bin/python" ]]'
        '[[ "$(python --version 2>&1)" == "${TARGET_PYTHON_VERSION}" ]]'